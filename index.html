<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi Karyawan - Payboss Cafe (GPS Akurat)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    .modal.hidden { display: none; }
    #attendance-section.disabled, #roster-selection.hidden { opacity: .5; pointer-events: none; }
    #roster-selection.hidden { display: none; }
    #map { height: 16rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">
    <div id="loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded-lg flex flex-col items-center">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4"></div>
        <p id="loading-text" class="text-lg font-medium">Memuat...</p>
      </div>
    </div>

    <div id="main-page" class="p-6 md:p-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Absensi Payboss Cafe</h1>
        <p class="text-xs text-gray-500">Pastikan situs diakses melalui <span class="font-semibold">HTTPS</span> agar GPS presisi.</p>
      </div>

      <div class="mb-6">
        <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Nama Karyawan</label>
        <select id="employee-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <option value="">-- Memuat Karyawan --</option>
        </select>
      </div>

      <div id="roster-selection" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
        <label for="shift-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Jadwal Shift Hari Ini</label>
        <div class="flex items-center gap-2">
          <select id="shift-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
            <option value="">-- Pilih Shift --</option>
            <option value="08:00">Pagi (08:00 - 16:00)</option>
            <option value="16:00">Sore (16:00 - 24:00)</option>
            <option value="00:00">Malam (00:00 - 08:00)</option>
          </select>
          <button id="save-roster-btn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Simpan</button>
        </div>
        <p id="roster-message" class="text-xs text-center mt-2"></p>
      </div>

      <div id="attendance-section" class="disabled space-y-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <div class="flex justify-between items-center">
            <p class="text-sm font-medium text-blue-800">Status GPS: <span id="gps-status" class="font-bold">Mencari lokasi...</span></p>
            <div class="flex items-center gap-2">
              <span id="gps-accuracy-chip" class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 hidden"></span>
              <button id="refresh-gps-btn" class="hidden text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-md">Coba Lagi</button>
            </div>
          </div>
          <p id="distance-info" class="text-xs text-blue-600"></p>
          <div class="flex items-center justify-between mt-2">
            <button id="check-location-btn" class="w-[58%] text-center py-2 px-4 border border-blue-300 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-white hover:bg-blue-50">Lihat Peta</button>
            <button id="calibrate-btn" class="w-[40%] text-center py-2 px-4 border border-amber-300 rounded-md shadow-sm text-sm font-medium text-amber-700 bg-white hover:bg-amber-50">Kalibrasi Ulang</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <button id="absen-masuk-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 font-medium">Absen Masuk</button>
          <button id="absen-pulang-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 font-medium">Absen Pulang</button>
          <button id="absen-sakit-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 font-medium">Sakit</button>
          <button id="absen-ijin-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-blue-500 hover:bg-blue-600 font-medium">Ijin</button>
        </div>
        <p id="absensi-message" class="mt-4 text-center text-sm"></p>
      </div>

      <div class="mt-8 border-t pt-6">
        <button id="manager-access-btn" class="w-full text-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Dasbor Manajer</button>
      </div>
    </div>

    <div id="manager-page" class="hidden p-6 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Dasbor Manajer</h2>
        <button id="back-to-main-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Kembali</button>
      </div>
      <a id="googleSheetLink" href="#" target="_blank" class="block w-full text-center mb-6 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Buka Google Sheet</a>

      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold mb-2">Laporan Harian</h3>
        <div class="mb-4">
          <label for="report-date" class="block text-sm font-medium text-gray-700">Pilih Tanggal</label>
          <input type="date" id="report-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
        </div>
        <button id="show-report-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Tampilkan</button>
      </div>

      <div id="report-results" class="mt-6 space-y-6"></div>
    </div>

    <div id="camera-modal" class="modal hidden fixed inset-0 bg-black z-40 flex flex-col items-center justify-center p-4">
      <video id="video-feed" autoplay playsinline class="w-full max-w-md rounded-lg"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="absolute bottom-4 left-4 right-4 flex justify-center gap-4">
        <button id="capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 focus:outline-none"></button>
        <button id="cancel-capture-btn" class="absolute right-4 px-4 py-2 bg-red-600 text-white rounded-lg">Batal</button>
      </div>
    </div>

    <div id="map-modal" class="modal hidden fixed inset-0 bg-black/75 z-40 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg w-full max-w-lg p-4">
        <h3 class="text-xl font-bold mb-4">Peta Lokasi</h3>
        <div id="map" class="w-full rounded-md"></div>
        <p class="text-xs mt-2 text-gray-600">Pin Merah: Lokasi Cafe • Pin Biru: Lokasi Anda.</p>
        <button id="close-map-btn" class="mt-4 w-full py-2 px-4 bg-gray-600 text-white rounded-md">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    // --- KONFIGURASI URL BARU ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywFtLjEmKzjTHGnDuO9lu_drgRYz8vxuqXP6TtQjs8jrX9k7QHC4k_98IsV-YSgNawMA/exec";

    // Koordinat Payboss (contoh)
    const CAFE_LAT = -8.679199;
    const CAFE_LON = 115.223842;
    const MAX_DISTANCE_METERS = 50;
    const TARGET_ACCURACY_M = 25;
    const MAX_WAIT_MS = 12000;
    const MAX_SAMPLES = 6;

    // --- ELEMENTS ---
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loading-text');
    const mainPage = document.getElementById('main-page');
    const managerPage = document.getElementById('manager-page');

    const employeeSelect = document.getElementById('employee-select');
    const attendanceSection = document.getElementById('attendance-section');
    const rosterSelection = document.getElementById('roster-selection');
    const shiftSelect = document.getElementById('shift-select');
    const saveRosterBtn = document.getElementById('save-roster-btn');
    const rosterMessage = document.getElementById('roster-message');

    const gpsStatus = document.getElementById('gps-status');
    const gpsAccuracyChip = document.getElementById('gps-accuracy-chip');
    const distanceInfo = document.getElementById('distance-info');
    const refreshGpsBtn = document.getElementById('refresh-gps-btn');
    const checkLocationBtn = document.getElementById('check-location-btn');
    const calibrateBtn = document.getElementById('calibrate-btn');

    const absenMasukBtn = document.getElementById('absen-masuk-btn');
    const absenPulangBtn = document.getElementById('absen-pulang-btn');
    const absenSakitBtn = document.getElementById('absen-sakit-btn');
    const absenIjinBtn = document.getElementById('absen-ijin-btn');
    const absensiMessage = document.getElementById('absensi-message');
    const managerAccessBtn = document.getElementById('manager-access-btn');

    const backToMainBtn = document.getElementById('back-to-main-btn');
    const googleSheetLink = document.getElementById('googleSheetLink');
    const reportDateInput = document.getElementById('report-date');
    const showReportBtn = document.getElementById('show-report-btn');
    const reportResults = document.getElementById('report-results');

    const cameraModal = document.getElementById('camera-modal');
    const videoFeed = document.getElementById('video-feed');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const cancelCaptureBtn = document.getElementById('cancel-capture-btn');

    const mapModal = document.getElementById('map-modal');
    const closeMapBtn = document.getElementById('close-map-btn');

    let selectedUser = null;
    let stream = null;
    let absenTipe = '';
    let bestPosition = null;

    function showLoading(text = 'Memuat...') { loadingText.textContent = text; loading.classList.remove('hidden'); }
    function hideLoading() { loading.classList.add('hidden'); }

    function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function fmt(n) { return Number.isFinite(n) ? n.toFixed(0) : '-'; }

    async function fetchEmployees() {
      showLoading('Memuat daftar karyawan...');
      try {
        const r = await fetch(`${SCRIPT_URL}?action=getEmployees`);
        const j = await r.json();
        if (j.success && j.data.length > 0) populateEmployeeDropdown(j.data);
        else employeeSelect.innerHTML = `<option value="">Gagal memuat karyawan. Cek Google Script.</option>`;
      } catch (e) {
        employeeSelect.innerHTML = `<option value="">Error jaringan. Periksa koneksi Anda.</option>`;
      } finally { hideLoading(); }
    }

    function populateEmployeeDropdown(employees) {
      employeeSelect.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
      employees.forEach(name => {
        const o = document.createElement('option'); o.value = name; o.textContent = name; employeeSelect.appendChild(o);
      });
    }

    async function onEmployeeSelect(e) {
      selectedUser = e.target.value; absensiMessage.textContent = ''; rosterMessage.textContent = ''; shiftSelect.value = '';
      if (selectedUser) { attendanceSection.classList.remove('disabled'); rosterSelection.classList.remove('hidden'); await fetchRosterInfo(selectedUser); }
      else { attendanceSection.classList.add('disabled'); rosterSelection.classList.add('hidden'); }
    }

    async function fetchRosterInfo(username) {
      rosterMessage.textContent = 'Memeriksa jadwal...';
      try {
        const r = await fetch(`${SCRIPT_URL}?action=getRoster&username=${encodeURIComponent(username)}`);
        const j = await r.json();
        if (j.success && j.jadwal) { shiftSelect.value = j.jadwal; rosterMessage.textContent = `Jadwal Anda hari ini: Shift ${j.jadwal}`; rosterMessage.className = 'text-xs text-center mt-2 text-green-600'; }
        else { rosterMessage.textContent = 'Anda belum memilih shift untuk hari ini.'; rosterMessage.className = 'text-xs text-center mt-2 text-yellow-600'; }
      } catch (e) { rosterMessage.textContent = 'Gagal memuat jadwal.'; rosterMessage.className = 'text-xs text-center mt-2 text-red-600'; }
    }

    async function saveRoster() {
      const selectedShift = shiftSelect.value;
      if (!selectedUser || !selectedShift) { rosterMessage.textContent = 'Pilih nama dan shift terlebih dahulu.'; rosterMessage.className = 'text-xs text-center mt-2 text-red-600'; return; }
      showLoading('Menyimpan jadwal...');
      try {
        const formData = new URLSearchParams();
        formData.append('action', 'setRoster'); formData.append('username', selectedUser); formData.append('shift', selectedShift);
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const j = await r.json();
        if (j.success) { rosterMessage.textContent = `Jadwal berhasil disimpan: Shift ${selectedShift}`; rosterMessage.className = 'text-xs text-center mt-2 text-green-600'; }
        else { rosterMessage.textContent = j.message || 'Gagal menyimpan jadwal.'; rosterMessage.className = 'text-xs text-center mt-2 text-red-600'; }
      } catch (e) { rosterMessage.textContent = 'Error jaringan saat menyimpan.'; rosterMessage.className = 'text-xs text-center mt-2 text-red-600'; }
      finally { hideLoading(); }
    }

    async function ensureGeoPermission() {
      if (!('permissions' in navigator)) return true;
      try {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        if (status.state === 'denied') {
          gpsStatus.textContent = 'Izin Lokasi Ditolak'; gpsStatus.className = 'font-bold text-red-700';
          distanceInfo.textContent = 'Aktifkan izin lokasi (Precise/Exact) di pengaturan browser/OS, lalu klik "Coba Lagi".';
          refreshGpsBtn.classList.remove('hidden');
          return false;
        }
        return true;
      } catch { return true; }
    }

    function getBestPosition({ maxWaitMs = MAX_WAIT_MS, maxSamples = MAX_SAMPLES } = {}) {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation tidak didukung'));
        let best = null; let count = 0; let timerId = null; let watchId = null;
        function finish() { if (watchId !== null) navigator.geolocation.clearWatch(watchId); if (timerId) clearTimeout(timerId); if (best) resolve(best); else reject(Object.assign(new Error('Tidak ada sampel posisi'), { code: 'NOSAMPLE' })); }
        watchId = navigator.geolocation.watchPosition((pos) => {
          count++; if (!best || (pos.coords.accuracy < best.coords.accuracy)) best = pos; if (best.coords.accuracy <= TARGET_ACCURACY_M || count >= maxSamples) finish();
        }, (err) => {
          if (watchId !== null) navigator.geolocation.clearWatch(watchId);
          navigator.geolocation.getCurrentPosition((pos) => { best = pos; finish(); }, (err2) => reject(err2), { enableHighAccuracy: true, timeout: maxWaitMs, maximumAge: 0 });
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: maxWaitMs });
        timerId = setTimeout(() => finish(), maxWaitMs);
      });
    }

    async function updateGps() {
      gpsStatus.textContent = 'Mencari lokasi...'; gpsStatus.className = 'font-bold text-blue-800';
      gpsAccuracyChip.classList.add('hidden'); distanceInfo.textContent = 'Pastikan Anda berada di area terbuka untuk sinyal terbaik.'; refreshGpsBtn.classList.add('hidden');
      if (!await ensureGeoPermission()) return;
      try {
        const pos = await getBestPosition();
        bestPosition = pos; const { latitude: lat, longitude: lon, accuracy } = pos.coords;
        const distance = getDistanceFromLatLonInM(lat, lon, CAFE_LAT, CAFE_LON);
        gpsAccuracyChip.textContent = `±${fmt(accuracy)} m`; gpsAccuracyChip.classList.remove('hidden');
        distanceInfo.textContent = `Jarak ke Cafe: ${fmt(distance)} m (Akurasi: ±${fmt(accuracy)} m)`;
        if (distance <= MAX_DISTANCE_METERS) { gpsStatus.textContent = 'Dalam Jangkauan'; gpsStatus.className = 'font-bold text-green-700'; }
        else { gpsStatus.textContent = 'Di Luar Jangkauan'; gpsStatus.className = 'font-bold text-red-700'; }
      } catch (error) {
        let message = 'Gagal mendapatkan lokasi. Pastikan izin lokasi aktif.';
        if (error && error.code === error.PERMISSION_DENIED) message = 'Anda menolak izin lokasi. Aktifkan di pengaturan browser.';
        else if (error && error.code === error.POSITION_UNAVAILABLE) message = 'Informasi lokasi tidak tersedia saat ini.';
        else if (error && (error.code === error.TIMEOUT || error.code === 'NOSAMPLE')) message = 'Waktu habis / tidak ada sampel memadai. Pindah ke area terbuka dan coba lagi.';
        gpsStatus.textContent = 'Gagal'; gpsStatus.className = 'font-bold text-red-700'; distanceInfo.textContent = message; refreshGpsBtn.classList.remove('hidden');
      }
    }

    async function calibrateGps() {
      gpsStatus.textContent = 'Kalibrasi ulang...'; gpsStatus.className = 'font-bold text-blue-800';
      try { await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); }); } catch {}
      updateGps();
    }

    async function startCamera(tipe) {
      if (!selectedUser) { absensiMessage.textContent = 'Pilih nama Anda terlebih dahulu.'; absensiMessage.className = 'mt-4 text-center text-sm text-red-600'; return; }
      absenTipe = tipe;
      try {
        const constraints = { video: { facingMode: 'user', width: { ideal: 720 }, height: { ideal: 1280 } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoFeed.srcObject = stream; cameraModal.classList.remove('hidden');
      } catch (err) { absensiMessage.textContent = 'Tidak bisa mengakses kamera. Pastikan izin diberikan.'; absensiMessage.className = 'mt-4 text-center text-sm text-red-600'; }
    }
    function stopCamera() { if (stream) stream.getTracks().forEach(t => t.stop()); cameraModal.classList.add('hidden'); }

    async function capturePhoto() {
      showLoading('Mengambil foto & lokasi...');
      const ctx = canvas.getContext('2d'); canvas.width = videoFeed.videoWidth; canvas.height = videoFeed.videoHeight; ctx.drawImage(videoFeed, 0, 0, canvas.width, canvas.height); const imageData = canvas.toDataURL('image/jpeg', 0.85); stopCamera();
      try {
        let pos = bestPosition; const now = Date.now();
        if (!pos || (now - pos.timestamp) > 120000) pos = await getBestPosition({ maxWaitMs: MAX_WAIT_MS, maxSamples: MAX_SAMPLES });
        const { latitude, longitude } = pos.coords;
        const result = await submitAbsen(absenTipe, imageData, latitude, longitude);
        absensiMessage.textContent = result.message; absensiMessage.className = `mt-4 text-center text-sm ${result.success ? 'text-green-600' : 'text-red-600'}`;
      } catch (error) {
        let msg = 'Gagal mendapatkan lokasi GPS. Pastikan izin aktif dan coba lagi.'; if (error && error.code === error.TIMEOUT) msg = 'Waktu permintaan lokasi habis. Pastikan sinyal GPS kuat.';
        absensiMessage.textContent = msg; absensiMessage.className = 'mt-4 text-center text-sm text-red-600';
      } finally { hideLoading(); }
    }

    async function handleSakitIjin(tipe) {
      if (!selectedUser) { absensiMessage.textContent = 'Pilih nama Anda terlebih dahulu.'; absensiMessage.className = 'mt-4 text-center text-sm text-red-600'; return; }
      showLoading('Mengirim data...');
      const result = await submitAbsen(tipe); absensiMessage.textContent = result.message; absensiMessage.className = `mt-4 text-center text-sm ${result.success ? 'text-green-600' : 'text-red-600'}`; hideLoading();
    }

    async function submitAbsen(tipe, imageData = null, lat = null, lon = null) {
      try {
        const formData = new URLSearchParams(); formData.append('action', 'submitAbsen'); formData.append('username', selectedUser); formData.append('tipe', tipe);
        if (imageData) formData.append('imageData', imageData); if (lat != null) formData.append('lat', lat); if (lon != null) formData.append('lon', lon);
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: formData }); return await r.json();
      } catch { return { success: false, message: 'Terjadi kesalahan jaringan saat mengirim data.' }; }
    }

    function showManagerDashboard() { mainPage.classList.add('hidden'); managerPage.classList.remove('hidden'); reportDateInput.valueAsDate = new Date(); }
    function showMainPage() { managerPage.classList.add('hidden'); mainPage.classList.remove('hidden'); }

    async function fetchManagerData() {
      const selectedDate = reportDateInput.value; if (!selectedDate) { alert('Silakan pilih tanggal terlebih dahulu.'); return; }
      showLoading('Memuat laporan...');
      try {
        const r = await fetch(`${SCRIPT_URL}?action=getManagerReport&date=${selectedDate}`);
        const j = await r.json();
        if (j.success) { googleSheetLink.href = j.sheetUrl; renderReport(j.data); }
        else { reportResults.innerHTML = `<p class=\"text-red-600\">Gagal memuat laporan: ${j.message}</p>`; }
      } catch { reportResults.innerHTML = '<p class="text-red-600">Terjadi kesalahan jaringan.</p>'; }
      finally { hideLoading(); }
    }

    function renderReport(data) {
      reportResults.innerHTML = '';
      if (!data || ((data.telat?.length || 0) === 0 && (data.tidakMasuk?.length || 0) === 0)) { reportResults.innerHTML = '<p class="text-gray-500">Tidak ada data karyawan telat atau tidak masuk untuk tanggal ini.</p>'; return; }
      if (data.telat?.length) {
        let html = '<div class="p-4 bg-red-50 rounded-lg"><h4 class="font-bold text-red-800 mb-2">Karyawan Telat</h4><ul class="divide-y divide-red-200">';
        data.telat.forEach(item => { html += `<li class="py-2"><p class="font-semibold">${item.username}</p><p class="text-sm text-red-700">Masuk: ${item.jamMasuk} (${item.keterangan})</p></li>`; });
        html += '</ul></div>'; reportResults.innerHTML += html;
      }
      if (data.tidakMasuk?.length) {
        let html = '<div class="p-4 bg-yellow-50 rounded-lg"><h4 class="font-bold text-yellow-800 mb-2">Karyawan Tidak Masuk</h4><ul class="divide-y divide-yellow-200">';
        data.tidakMasuk.forEach(item => { html += `<li class="py-2"><p class="font-semibold">${item.username}</p><p class="text-sm text-yellow-700">Seharusnya masuk jam ${item.jadwal}</p></li>`; });
        html += '</ul></div>'; reportResults.innerHTML += html;
      }
    }

    let leafletMap = null; let cafeMarker = null; let userMarker = null;
    function showMap() {
      if (!bestPosition) { alert('Lokasi Anda belum ditemukan. Mohon tunggu atau kalibrasi ulang.'); return; }
      const { latitude: uLat, longitude: uLon } = bestPosition.coords;
      mapModal.classList.remove('hidden');
      setTimeout(() => {
        if (!leafletMap) {
          leafletMap = L.map('map');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(leafletMap);
        }
        if (cafeMarker) cafeMarker.remove(); if (userMarker) userMarker.remove();
        cafeMarker = L.marker([CAFE_LAT, CAFE_LON], { title: 'Payboss Cafe' }).addTo(leafletMap).bindPopup('Payboss Cafe');
        const blueIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png' });
        userMarker = L.marker([uLat, uLon], { icon: blueIcon, title: 'Lokasi Anda' }).addTo(leafletMap).bindPopup('Lokasi Anda');
        const bounds = L.latLngBounds([[CAFE_LAT, CAFE_LON], [uLat, uLon]]); leafletMap.fitBounds(bounds.pad(0.3));
      }, 50);
    }

    employeeSelect.addEventListener('change', onEmployeeSelect);
    saveRosterBtn.addEventListener('click', saveRoster);
    absenMasukBtn.addEventListener('click', () => startCamera('masuk'));
    absenPulangBtn.addEventListener('click', () => startCamera('pulang'));
    absenSakitBtn.addEventListener('click', () => handleSakitIjin('sakit'));
    absenIjinBtn.addEventListener('click', () => handleSakitIjin('ijin'));
    captureBtn.addEventListener('click', capturePhoto);
    cancelCaptureBtn.addEventListener('click', stopCamera);
    const checkLocationBtnEl = document.getElementById('check-location-btn');
    checkLocationBtnEl.addEventListener('click', showMap);
    closeMapBtn.addEventListener('click', () => mapModal.classList.add('hidden'));
    const managerAccessBtnEl = document.getElementById('manager-access-btn');
    managerAccessBtnEl.addEventListener('click', showManagerDashboard);
    backToMainBtn.addEventListener('click', showMainPage);
    showReportBtn.addEventListener('click', fetchManagerData);
    refreshGpsBtn.addEventListener('click', updateGps);
    calibrateBtn.addEventListener('click', calibrateGps);

    document.addEventListener('DOMContentLoaded', async () => {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        const warn = 'Situs tidak melalui HTTPS. Beberapa perangkat akan menolak GPS presisi.';
        console.warn(warn); distanceInfo.textContent = warn;
      }
      fetchEmployees();
      updateGps();
    });
  </script>
</body>
</html>