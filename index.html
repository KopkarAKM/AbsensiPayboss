<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayBoss Cafe - Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .notification-slide { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Mengatur ukuran kamera potret */
        .camera-preview { 
            border-radius: 15px; 
            border: 3px solid #667eea;
            width: 320px;  /* Lebar potret */
            height: 480px; /* Tinggi potret */
            margin-left: auto;
            margin-right: auto;
            object-fit: cover;
        }
    </style>
</head>
<body class="min-h-full bg-gray-50">
    <div class="min-h-full">
        <!-- Header -->
        <header class="gradient-bg text-white p-4">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-full"><span class="text-2xl">‚òï</span></div>
                    <div>
                        <h1 class="text-xl font-bold">PayBoss Cafe</h1>
                        <p class="text-sm opacity-90">Sistem Absensi Karyawan</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm opacity-90" id="header-greeting">Selamat datang,</p>
                    <p class="font-semibold" id="employeeName">Silakan Pilih Nama Anda</p>
                </div>
            </div>
        </header>

        <!-- Layar Pilihan Karyawan (Visible by default) -->
        <div id="employee-selection-screen" class="max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-lg card-shadow p-6 text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Pilih Nama Anda untuk Absen</h2>
                <p class="text-gray-600 mb-6">Tablet ini digunakan untuk absensi bersama.</p>
                <div id="employee-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Daftar Karyawan akan dimuat di sini -->
                    <p class="col-span-full text-gray-500">Memuat daftar karyawan...</p>
                </div>
            </div>
        </div>

        <!-- Layar Absensi (Hidden by default) -->
        <div id="attendance-screen" class="hidden">
            <!-- Tombol Kembali -->
            <div class="max-w-4xl mx-auto p-4 -mb-2">
                <button onclick="goBackToSelection()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                    &larr; Ganti Pengguna
                </button>
            </div>
            
            <main class="max-w-4xl mx-auto p-4 space-y-6">
                <!-- Current Time & Shift Info -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-800" id="currentTime">00:00:00</div>
                        <div class="text-lg text-gray-600" id="currentDate">Memuat tanggal...</div>
                        <div id="shiftInfoContainer" class="mt-4 inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full hidden">
                            <span class="font-semibold" id="shiftInfo">Memuat shift...</span>
                        </div>
                    </div>
                </div>

                <!-- Attendance Section -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üì∏</span> Absensi Hari Ini
                    </h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Camera Section -->
                        <div class="space-y-4">
                            <div class="bg-gray-100 rounded-lg p-4 text-center">
                                <!-- Ukuran potret diterapkan di sini -->
                                <video id="cameraPreview" class="camera-preview bg-gray-300 hidden" autoplay></video>
                                <canvas id="photoCanvas" class="camera-preview bg-gray-300 hidden"></canvas>
                                <div id="cameraPlaceholder" class="camera-preview bg-gray-300 flex items-center justify-center">
                                    <div class="text-center text-gray-500">
                                        <span class="text-4xl block mb-2">üì∑</span>
                                        <p>Klik tombol untuk mengaktifkan kamera</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="startCameraBtn" onclick="startCamera()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                    Aktifkan Kamera
                                </button>
                                <button id="takePhotoBtn" onclick="takePhoto()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors hidden">
                                    Ambil Foto
                                </button>
                            </div>
                        </div>
                        <!-- Attendance Buttons -->
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-2">Status Absensi</h3>
                                <div id="attendanceStatus" class="text-sm text-green-600">
                                    Belum absen masuk hari ini
                                </div>
                                <div id="workDuration" class="text-sm text-gray-600 mt-1 hidden">
                                    Durasi kerja: <span id="workTime">0 jam 0 menit</span>
                                </div>
                            </div>
                            <button id="clockInBtn" onclick="clockIn()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                                üïê Absen Masuk
                            </button>
                            <button id="clockOutBtn" onclick="showClockOutModal()" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors font-semibold hidden">
                                üïê Absen Keluar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Work Schedule -->
                <div class="bg-white rounded-lg card-shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üìÖ</span> Jadwal Roster Kerja
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="text-left p-3 font-semibold">Hari</th>
                                    <th class="text-left p-3 font-semibold">Tanggal</th>
                                    <th class="text-left p-3 font-semibold">Shift</th>
                                    <th class="text-left p-3 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Data akan diisi oleh JavaScript -->
                                <tr><td colspan="4" class="text-center p-4 text-gray-500">Memuat jadwal...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modals -->
        <div id="clockOutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                 <h3 class="text-lg font-bold text-gray-800 mb-4">Konfirmasi Absen Keluar</h3>
                <div id="earlyLeaveWarning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 hidden">
                    <div class="flex items-start">
                        <span class="text-yellow-500 mr-2">‚ö†Ô∏è</span>
                        <div>
                            <p class="font-semibold text-yellow-800">Peringatan!</p>
                            <p class="text-yellow-700 text-sm">Anda akan pulang lebih cepat dari jadwal shift. Mohon berikan alasan kepada manager.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="leaveReason" class="block text-sm font-medium text-gray-700 mb-2">Alasan ijin pulang cepat:</label>
                        <textarea id="leaveReason" rows="3" class="w-full border border-gray-300 rounded-lg p-3 text-sm" placeholder="Contoh: Ada keperluan keluarga mendesak..."></textarea>
                    </div>
                </div>
                <div class="text-center mb-4">
                    <p class="text-gray-600">Waktu keluar: <span id="clockOutTime" class="font-semibold"></span></p>
                    <p class="text-gray-600">Total jam kerja: <span id="totalWorkTime" class="font-semibold"></span></p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeClockOutModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                        Batal
                    </button>
                    <button onclick="confirmClockOut()" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        Konfirmasi Keluar
                    </button>
                </div>
            </div>
        </div>
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg max-w-sm w-full p-6 text-center">
                <div class="text-green-500 text-5xl mb-4">‚úÖ</div>
                <h3 class="text-lg font-bold text-gray-800 mb-2" id="successTitle">Absensi Berhasil!</h3>
                <p class="text-gray-600 mb-4" id="successMessage">Aksi berhasil dicatat</p>
                <button onclick="closeSuccessModalAndReset()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                    OK
                </button>
            </div>
        </div>

    </div>

    <script>
        // PASTE URL DEPLOYMENT BARU ANDA DI SINI
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzdqB1CNQl55Nw7WFqquuLyjfhEcfViIiCNmZh149EhQDp5La28sChQC5eLRMEq4-FU/exec";

        const selectionScreen = document.getElementById('employee-selection-screen');
        const attendanceScreen = document.getElementById('attendance-screen');
        const employeeListDiv = document.getElementById('employee-list');

        let clockInTime = null;
        let currentStream = null;
        let photoTaken = false;
        let employeeId = null;
        let employeeData = {};
        let workDurationInterval = null;

        async function loadEmployeeList() {
            try {
                // Tampilkan loading
                employeeListDiv.innerHTML = '<p class="col-span-full text-gray-500">Memuat daftar karyawan...</p>';
                const response = await fetch(`${GAS_URL}?action=getEmployeeList`);
                if (!response.ok) { throw new Error(`Network response error: ${response.statusText}`); }
                const result = await response.json();
                
                if (result.status === 'success' && result.data.length > 0) {
                    employeeListDiv.innerHTML = ''; 
                    result.data.forEach(emp => {
                        const button = document.createElement('button');
                        button.className = "bg-blue-500 text-white font-bold py-4 px-2 rounded-lg hover:bg-blue-600 transition-colors shadow-md";
                        button.textContent = emp.nama;
                        button.onclick = () => selectEmployee(emp.id);
                        employeeListDiv.appendChild(button);
                    });
                } else if (result.status === 'error') {
                     throw new Error(result.message);
                } else {
                    employeeListDiv.innerHTML = '<p class="col-span-full text-red-500">Gagal memuat daftar karyawan atau tidak ada data.</p>';
                }
            } catch (error) {
                employeeListDiv.innerHTML = `<p class="col-span-full text-red-500">Error: ${error.message}. Pastikan URL GAS benar dan sudah di-deploy.</p>`;
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function selectEmployee(selectedId) {
            employeeId = selectedId;
            selectionScreen.classList.add('hidden');
            attendanceScreen.classList.remove('hidden');
            document.getElementById('header-greeting').textContent = "Selamat datang,";
            loadEmployeeData();
        }

        function goBackToSelection() {
            employeeId = null;
            employeeData = {};
            photoTaken = false;
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (workDurationInterval) {
                clearInterval(workDurationInterval);
                workDurationInterval = null;
            }

            resetAttendanceUI();
            
            attendanceScreen.classList.add('hidden');
            selectionScreen.classList.remove('hidden');
            document.getElementById('employeeName').textContent = "Silakan Pilih Nama Anda";
            // Muat ulang daftar karyawan jika terjadi error sebelumnya
            if (employeeListDiv.innerHTML.includes('Error')) {
                loadEmployeeList();
            }
        }
        
        function resetAttendanceUI() {
            document.getElementById('employeeName').textContent = 'Memuat...';
            document.getElementById('shiftInfoContainer').classList.add('hidden');
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('photoCanvas').classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('startCameraBtn').classList.remove('hidden');
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            takePhotoBtn.classList.add('hidden');
            takePhotoBtn.textContent = 'Ambil Foto';
            takePhotoBtn.onclick = takePhoto;
            
            document.getElementById('attendanceStatus').textContent = 'Belum absen masuk hari ini';
            document.getElementById('workDuration').classList.add('hidden');
            document.getElementById('workTime').textContent = '0 jam 0 menit';
            const clockInBtn = document.getElementById('clockInBtn');
            clockInBtn.classList.remove('hidden');
            clockInBtn.disabled = false;
            clockInBtn.classList.remove('bg-gray-400');
            clockInBtn.classList.add('bg-green-600');
            document.getElementById('clockOutBtn').classList.add('hidden');

            document.getElementById('scheduleTable').innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Memuat jadwal...</td></tr>';
        }

        async function loadEmployeeData() {
            if (!employeeId) return;
            showNotification('Memuat data Anda...', 'info');
            try {
                const response = await fetch(`${GAS_URL}?action=getEmployeeData&id=${employeeId}`);
                if (!response.ok) { throw new Error(`Network response error: ${response.statusText}`); }
                const result = await response.json();

                if (result.status === 'success') {
                    employeeData = result.data;
                    populateEmployeeData(employeeData);
                    showNotification('Data berhasil dimuat', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
                goBackToSelection();
            }
        }
        
        function populateEmployeeData(data) {
            document.getElementById('employeeName').textContent = data.employeeName;
            if(data.currentShift && data.currentShift !== "Hari Ini Libur") {
                document.getElementById('shiftInfo').textContent = data.currentShift;
                document.getElementById('shiftInfoContainer').classList.remove('hidden');
            } else {
                document.getElementById('shiftInfo').textContent = "Hari Ini Libur";
                document.getElementById('shiftInfoContainer').classList.remove('hidden');
            }

            if (data.attendanceStatus) {
                const status = data.attendanceStatus;
                
                try {
                     // Check jika jam masuk valid
                    if (status.Jam_Masuk && status.Jam_Masuk.includes(':')) {
                        const [day, month, year] = status.Tanggal.split('/').map(Number);
                        const [hour, minute] = status.Jam_Masuk.split(':').map(Number);
                        clockInTime = new Date(year, month - 1, day, hour, minute);
                    } else {
                        throw new Error("Format Jam Masuk tidak valid");
                    }
                } catch (e) {
                    console.error("Error parsing clockInTime:", e, status);
                    showNotification("Gagal memproses waktu absen masuk.", "error");
                    clockInTime = null; // Set null jika error
                }


                if (!status.Jam_Keluar) {
                    document.getElementById('attendanceStatus').textContent = `Sudah absen masuk pada ${status.Jam_Masuk}`;
                    document.getElementById('workDuration').classList.remove('hidden');
                    document.getElementById('clockInBtn').classList.add('hidden');
                    document.getElementById('clockOutBtn').classList.remove('hidden');
                    if(clockInTime) startWorkDurationTimer(); // Hanya jalankan jika clockInTime valid
                } else {
                    document.getElementById('attendanceStatus').textContent = `Selesai bekerja. Absen keluar pada ${status.Jam_Keluar}`;
                    const duration = status.Durasi_Menit || 0;
                    document.getElementById('workTime').textContent = `${Math.floor(duration / 60)} jam ${duration % 60} menit`;
                    document.getElementById('workDuration').classList.remove('hidden');
                    document.getElementById('clockInBtn').classList.add('hidden');
                    document.getElementById('clockOutBtn').classList.add('hidden');
                }
            } else {
                if (!data.currentShift || data.currentShift === "Hari Ini Libur") {
                    document.getElementById('attendanceStatus').textContent = "Anda tidak ada jadwal hari ini.";
                    const clockInBtn = document.getElementById('clockInBtn');
                    clockInBtn.disabled = true;
                    clockInBtn.classList.add('bg-gray-400');
                    clockInBtn.classList.remove('bg-green-600');
                } else {
                     document.getElementById('attendanceStatus').textContent = "Belum absen masuk hari ini";
                }
            }
            const scheduleTable = document.getElementById('scheduleTable');
            scheduleTable.innerHTML = '';
            if(data.scheduleList && data.scheduleList.length > 0) {
                data.scheduleList.forEach(item => {
                    const statusClass = item.status === 'Sedang Berlangsung' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600';
                    scheduleTable.innerHTML += `<tr class="border-b"><td class="p-3 font-medium">${item.hari}</td><td class="p-3">${item.tanggal}</td><td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${item.shift}</span></td><td class="p-3"><span class="${statusClass} px-2 py-1 rounded text-xs">${item.status}</span></td></tr>`;
                });
            } else {
                scheduleTable.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Tidak ada jadwal ditemukan.</td></tr>';
            }
        }
        
        function updateTime() {
            const currentTimeEl = document.getElementById('currentTime');
            const currentDateEl = document.getElementById('currentDate');
            if (!currentTimeEl || !currentDateEl) return;
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            currentDateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function startCamera() {
             const video = document.getElementById('cameraPreview');
             const canvas = document.getElementById('photoCanvas');
             // Set ukuran eksplisit untuk canvas agar sesuai
             const previewBox = document.getElementById('cameraPlaceholder');
             canvas.width = previewBox.offsetWidth;
             canvas.height = previewBox.offsetHeight;

            try {
                // Minta resolusi yang mendekati potret
                const constraints = { 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 480 },
                        height: { ideal: 640 }
                    } 
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                canvas.classList.add('hidden'); // Sembunyikan canvas
                video.classList.remove('hidden'); // Tampilkan video
                document.getElementById('startCameraBtn').classList.add('hidden');
                document.getElementById('takePhotoBtn').classList.remove('hidden');
            } catch (error) { 
                console.error("Error starting camera:", error);
                showNotification('Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan.', 'error'); 
            }
        }

        function takePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set ukuran canvas agar sesuai dengan video feed
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Gambar frame video ke canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            video.classList.add('hidden'); // Sembunyikan video
            canvas.classList.remove('hidden'); // Tampilkan canvas (foto)
            
            if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
            photoTaken = true;
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            takePhotoBtn.textContent = 'Foto Ulang';
            takePhotoBtn.onclick = retakePhoto;
        }

        function retakePhoto() {
            document.getElementById('photoCanvas').classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.add('hidden'); // placeholder tetap hidden
            const startCameraBtn = document.getElementById('startCameraBtn');
            startCameraBtn.classList.add('hidden'); // tombol start tetap hidden
            const takePhotoBtn = document.getElementById('takePhotoBtn');
            takePhotoBtn.classList.add('hidden'); // Sembunyikan tombol foto
            
            photoTaken = false;
            
            // Langsung restart kamera
            startCamera();
            
            // Ubah tombol kembali
            takePhotoBtn.textContent = 'Ambil Foto';
            takePhotoBtn.onclick = takePhoto;
        }


        async function clockIn() {
            if (!photoTaken) { return showNotification('Mohon ambil foto terlebih dahulu untuk absensi.', 'error'); }
            showNotification('Mencatat absen masuk...', 'info');
            
            // Disable tombol
            const clockInBtn = document.getElementById('clockInBtn');
            clockInBtn.disabled = true;
            clockInBtn.textContent = "Mengirim...";
            
            const canvas = document.getElementById('photoCanvas');
            const photoData = canvas.toDataURL('image/jpeg', 0.8); // Kompresi foto
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clockIn', employeeId: employeeId, photoBase64: photoData, shiftStartTime: employeeData.shiftStartTime })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const result = await response.json(); 

                if (result.status === 'success') {
                    const now = new Date();
                    clockInTime = now;
                    document.getElementById('attendanceStatus').textContent = `Sudah absen masuk pada ${now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    document.getElementById('workDuration').classList.remove('hidden');
                    document.getElementById('clockInBtn').classList.add('hidden');
                    document.getElementById('clockOutBtn').classList.remove('hidden');
                    showSuccessModal('Absensi Masuk Berhasil!', `Absen masuk berhasil dicatat pada ${now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`);
                    startWorkDurationTimer();
                } else {
                    throw new Error(result.message || 'Gagal mencatat absensi');
                }

            } catch (error) { 
                showNotification(`Error: ${error.message}`, 'error'); 
                // Kembalikan tombol ke state normal jika error
                clockInBtn.disabled = false;
                clockInBtn.textContent = "üïê Absen Masuk";
            }
        }
        
        function startWorkDurationTimer() {
            if (workDurationInterval) clearInterval(workDurationInterval);
            updateWorkDuration();
            workDurationInterval = setInterval(updateWorkDuration, 60000);
        }

        function updateWorkDuration() {
            if (!clockInTime || isNaN(clockInTime.getTime())) return; // Cek validitas Date
            const now = new Date();
            const diffMs = now - clockInTime;
            const hours = Math.floor(diffMs / 3600000);
            const minutes = Math.floor((diffMs % 3600000) / 60000);
            document.getElementById('workTime').textContent = `${hours} jam ${minutes} menit`;
        }

        function showClockOutModal() {
            const now = new Date();
            let isEarlyLeave = false;
            if (employeeData.shiftEndTime) {
                try {
                    const [endHour, endMinute] = employeeData.shiftEndTime.split(':').map(Number);
                    if (now.getHours() < endHour || (now.getHours() === endHour && now.getMinutes() < endMinute)) {
                        isEarlyLeave = true;
                    }
                } catch(e) { console.error("Error parsing shiftEndTime:", e, employeeData.shiftEndTime); }
            }
            
            document.getElementById('clockOutTime').textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            if (clockInTime && !isNaN(clockInTime.getTime())) {
                const diffMs = now - clockInTime;
                const hours = Math.floor(diffMs / 3600000);
                const minutes = Math.floor((diffMs % 3600000) / 60000);
                document.getElementById('totalWorkTime').textContent = `${hours} jam ${minutes} menit`;
            } else {
                 document.getElementById('totalWorkTime').textContent = "Data tidak tersedia";
            }
            
            document.getElementById('earlyLeaveWarning').classList.toggle('hidden', !isEarlyLeave);
            document.getElementById('clockOutModal').classList.remove('hidden');
        }

        function closeClockOutModal() {
            document.getElementById('clockOutModal').classList.add('hidden');
            document.getElementById('leaveReason').value = '';
        }

        async function confirmClockOut() {
            const now = new Date();
            let isEarlyLeave = !document.getElementById('earlyLeaveWarning').classList.contains('hidden');
            let reason = isEarlyLeave ? document.getElementById('leaveReason').value.trim() : null;
            if (isEarlyLeave && !reason) { return showNotification('Mohon berikan alasan untuk pulang lebih cepat.', 'error'); }
            
            showNotification('Mencatat absen keluar...', 'info');
            
            // Disable tombol
            const confirmBtn = event.target;
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Mengirim...";
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clockOut', employeeId: employeeId, reason: reason })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const result = await response.json(); 

                if (result.status === 'success') {
                    document.getElementById('attendanceStatus').textContent = `Sudah absen keluar pada ${now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                    document.getElementById('clockOutBtn').classList.add('hidden');
                    if (workDurationInterval) clearInterval(workDurationInterval);
                    closeClockOutModal();
                    showSuccessModal('Absensi Keluar Berhasil!', `Absen keluar berhasil dicatat pada ${now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`);
                    if(reason) { showNotification('Permintaan pulang cepat telah dikirim ke manajer.', 'info'); }
                } else {
                    throw new Error(result.message || 'Gagal mencatat absensi keluar');
                }

            } catch (error) { 
                showNotification(`Error: ${error.message}`, 'error'); 
            } finally {
                // Kembalikan tombol ke state normal
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Konfirmasi Keluar";
            }
        }

        function showSuccessModal(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closeSuccessModalAndReset() {
            document.getElementById('successModal').classList.add('hidden');
            setTimeout(goBackToSelection, 300);
        }

        function showNotification(message, type = 'info') {
            // Hapus notifikasi lama jika ada
            const oldNotification = document.querySelector('.notification-slide');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            let bgColor = 'bg-green-500'; // default success
            if (type === 'error') {
                bgColor = 'bg-red-500';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
            }
            
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 notification-slide ${bgColor}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => { 
                if (document.body.contains(notification)) {
                    notification.remove(); 
                }
            }, 3000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadEmployeeList();
        });
    </script>
</body>
</html>
