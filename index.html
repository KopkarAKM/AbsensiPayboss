<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Karyawan - Payboss Cafe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal.hidden {
            display: none;
        }
        #attendance-section.disabled, #roster-selection.hidden {
            opacity: 0.5;
            pointer-events: none;
        }
         #roster-selection.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">

        <!-- Loading Spinner -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-5 rounded-lg flex flex-col items-center">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4"></div>
                <p id="loading-text" class="text-lg font-medium">Memuat...</p>
            </div>
        </div>
        
        <!-- Main Page -->
        <div id="main-page" class="p-6 md:p-8">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Absensi Payboss Cafe</h1>
            </div>

            <!-- Employee Selection -->
            <div class="mb-6">
                <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Nama Karyawan</label>
                <select id="employee-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="">-- Memuat Karyawan --</option>
                </select>
            </div>
            
            <!-- Roster Selection -->
            <div id="roster-selection" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                <label for="shift-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Jadwal Shift Hari Ini</label>
                <div class="flex items-center space-x-2">
                    <select id="shift-select" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        <option value="">-- Pilih Shift --</option>
                        <option value="08:00">Pagi (08:00 - 16:00)</option>
                        <option value="16:00">Sore (16:00 - 24:00)</option>
                        <option value="00:00">Malam (00:00 - 08:00)</option>
                    </select>
                    <button id="save-roster-btn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Simpan</button>
                </div>
                <p id="roster-message" class="text-xs text-center mt-2"></p>
            </div>

            <!-- Attendance Section -->
            <div id="attendance-section" class="disabled space-y-6">
                 <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-medium text-blue-800">Status GPS: <span id="gps-status" class="font-bold">Mencari lokasi...</span></p>
                        <button id="refresh-gps-btn" class="hidden text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-md">Coba Lagi</button>
                    </div>
                    <p id="distance-info" class="text-xs text-blue-600"></p>
                    <button id="check-location-btn" class="mt-2 w-full text-center py-2 px-4 border border-blue-300 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-white hover:bg-blue-50">Cek Lokasi Saya di Peta</button>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="absen-masuk-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 font-medium">Absen Masuk</button>
                    <button id="absen-pulang-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 font-medium">Absen Pulang</button>
                    <button id="absen-sakit-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 font-medium">Sakit</button>
                    <button id="absen-ijin-btn" class="w-full py-3 px-4 rounded-md shadow-sm text-white bg-blue-500 hover:bg-blue-600 font-medium">Ijin</button>
                </div>
                <p id="absensi-message" class="mt-4 text-center text-sm"></p>
            </div>
            
             <!-- Manager Access -->
            <div class="mt-8 border-t pt-6">
                 <button id="manager-access-btn" class="w-full text-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Dasbor Manajer</button>
            </div>
        </div>


        <!-- Manager Page -->
        <div id="manager-page" class="hidden p-6 md:p-8">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Dasbor Manajer</h2>
                <button id="back-to-main-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Kembali</button>
            </div>
            <a id="googleSheetLink" href="#" target="_blank" class="block w-full text-center mb-6 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">Buka Google Sheet</a>
            
            <div class="space-y-8">
                <!-- Daily Report -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Laporan Harian</h3>
                    <div class="mb-4">
                        <label for="report-date" class="block text-sm font-medium text-gray-700">Pilih Tanggal</label>
                        <input type="date" id="report-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <button id="show-report-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Tampilkan Laporan Harian</button>
                    <div id="report-results" class="mt-6 space-y-4"></div>
                </div>

                <!-- Monthly Chart -->
                 <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Grafik Pelanggaran Bulanan</h3>
                    <div class="mb-4">
                        <label for="chart-month" class="block text-sm font-medium text-gray-700">Pilih Bulan & Tahun</label>
                        <input type="month" id="chart-month" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <button id="show-chart-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Tampilkan Grafik</button>
                    <div id="chart-container" class="mt-4">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Modal -->
        <div id="camera-modal" class="modal hidden fixed inset-0 bg-black z-40 flex flex-col items-center justify-center p-4">
            <video id="video-feed" autoplay playsinline class="w-full max-w-md rounded-lg"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="absolute bottom-4 left-4 right-4 flex justify-center space-x-4">
                <button id="capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 focus:outline-none"></button>
                <button id="cancel-capture-btn" class="absolute right-4 px-4 py-2 bg-red-600 text-white rounded-lg">Batal</button>
            </div>
        </div>
        
        <!-- Map Modal -->
        <div id="map-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 z-40 flex items-center justify-center p-4">
             <div class="bg-white rounded-lg w-full max-w-lg p-4">
                 <h3 class="text-xl font-bold mb-4">Peta Lokasi</h3>
                 <div id="map-container" class="w-full h-64 bg-gray-200 rounded-md"></div>
                 <p class="text-xs mt-2 text-gray-600">Pin Merah: Lokasi Cafe. Pin Biru: Lokasi Anda Saat Ini.</p>
                 <button id="close-map-btn" class="mt-4 w-full py-2 px-4 bg-gray-600 text-white rounded-md">Tutup</button>
            </div>
        </div>

    </div>

    <script>
        // --- ELEMENT SELECTORS ---
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        
        const mainPage = document.getElementById('main-page');
        const managerPage = document.getElementById('manager-page');
        
        const employeeSelect = document.getElementById('employee-select');
        const attendanceSection = document.getElementById('attendance-section');
        const rosterSelection = document.getElementById('roster-selection');
        const shiftSelect = document.getElementById('shift-select');
        const saveRosterBtn = document.getElementById('save-roster-btn');
        const rosterMessage = document.getElementById('roster-message');

        const gpsStatus = document.getElementById('gps-status');
        const distanceInfo = document.getElementById('distance-info');
        const refreshGpsBtn = document.getElementById('refresh-gps-btn');
        const checkLocationBtn = document.getElementById('check-location-btn');

        const absenMasukBtn = document.getElementById('absen-masuk-btn');
        const absenPulangBtn = document.getElementById('absen-pulang-btn');
        const absenSakitBtn = document.getElementById('absen-sakit-btn');
        const absenIjinBtn = document.getElementById('absen-ijin-btn');
        const absensiMessage = document.getElementById('absensi-message');
        const managerAccessBtn = document.getElementById('manager-access-btn');
        
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const googleSheetLink = document.getElementById('googleSheetLink');
        const reportDateInput = document.getElementById('report-date');
        const showReportBtn = document.getElementById('show-report-btn');
        const reportResults = document.getElementById('report-results');

        const chartMonthInput = document.getElementById('chart-month');
        const showChartBtn = document.getElementById('show-chart-btn');
        const monthlyChartCanvas = document.getElementById('monthlyChart');
        
        const cameraModal = document.getElementById('camera-modal');
        const videoFeed = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCaptureBtn = document.getElementById('cancel-capture-btn');
        
        const mapModal = document.getElementById('map-modal');
        const mapContainer = document.getElementById('map-container');
        const closeMapBtn = document.getElementById('close-map-btn');
        
        // --- KONFIGURASI ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx02LMszd17RGJk26XZFy5RkuSe6sB_0_3dM_0bJN6RNEjmIt0hvy-TsjmPAI1e2RFEwA/exec";
        const CAFE_LAT = -2.160283;
        const CAFE_LON = 115.406322;
        const MAX_DISTANCE_METERS = 50;
        
        let selectedUser = null;
        let stream = null;
        let absenTipe = '';
        let lastKnownPosition = null;
        let monthlyChart = null;

        // --- FUNCTIONS ---
        
        function showLoading(text = 'Memuat...') {
            loadingText.textContent = text;
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

       async function fetchAPI(action, params = {}) {
            try {
                const formData = new URLSearchParams();
                formData.append('action', action);
                for (const key in params) {
                    formData.append(key, params[key]);
                }
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Fetch API error for action "${action}":`, error);
                alert(`Terjadi error jaringan saat menjalankan '${action}'. Cek konsol (F12) untuk detail.`);
                return { success: false, message: `Error jaringan: ${error.message}` };
            }
        }


        async function fetchEmployees() {
            showLoading('Memuat daftar karyawan...');
            const result = await fetchAPI('getEmployees');
            if (result.success && result.data.length > 0) {
                populateEmployeeDropdown(result.data);
            } else {
                employeeSelect.innerHTML = `<option value="">Gagal memuat karyawan. Cek Google Script.</option>`;
                alert(result.message || 'Gagal memuat daftar karyawan. Pastikan script sudah di-deploy ulang dengan benar.');
            }
            hideLoading();
        }


        function populateEmployeeDropdown(employees) {
            employeeSelect.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
            employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeSelect.appendChild(option);
            });
        }
        
        async function onEmployeeSelect(event) {
            selectedUser = event.target.value;
            absensiMessage.textContent = '';
            rosterMessage.textContent = '';
            shiftSelect.value = '';
            
            if (selectedUser) {
                attendanceSection.classList.remove('disabled');
                rosterSelection.classList.remove('hidden');
                await fetchRosterInfo(selectedUser);
            } else {
                attendanceSection.classList.add('disabled');
                rosterSelection.classList.add('hidden');
            }
        }

        async function fetchRosterInfo(username) {
            rosterMessage.textContent = 'Memeriksa jadwal...';
            const result = await fetchAPI('getRoster', { username });
            if (result.success && result.jadwal) {
                shiftSelect.value = result.jadwal;
                rosterMessage.textContent = `Jadwal Anda hari ini: Shift ${result.jadwal}`;
                rosterMessage.className = 'text-xs text-center mt-2 text-green-600';
            } else {
                rosterMessage.textContent = `Anda belum memilih shift untuk hari ini.`;
                 rosterMessage.className = 'text-xs text-center mt-2 text-yellow-600';
            }
        }
        
        async function saveRoster() {
            const selectedShift = shiftSelect.value;
            if (!selectedUser || !selectedShift) {
                rosterMessage.textContent = 'Pilih nama dan shift terlebih dahulu.';
                rosterMessage.className = 'text-xs text-center mt-2 text-red-600';
                return;
            }
            
            showLoading('Menyimpan jadwal...');
            const result = await fetchAPI('setRoster', { username: selectedUser, shift: selectedShift });

            if(result.success) {
                rosterMessage.textContent = `Jadwal berhasil disimpan: Shift ${selectedShift}`;
                rosterMessage.className = 'text-xs text-center mt-2 text-green-600';
            } else {
                rosterMessage.textContent = result.message || 'Gagal menyimpan jadwal.';
                rosterMessage.className = 'text-xs text-center mt-2 text-red-600';
            }
            hideLoading();
        }

        function checkInitialGPS() {
            gpsStatus.textContent = "Mencari lokasi...";
            gpsStatus.className = 'font-bold text-blue-800';
            distanceInfo.textContent = "Pastikan Anda berada di area terbuka untuk sinyal terbaik.";
            refreshGpsBtn.classList.add('hidden');

            if (!navigator.geolocation) {
                gpsStatus.textContent = "Tidak Didukung";
                distanceInfo.textContent = "Browser Anda tidak mendukung Geolocation.";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    lastKnownPosition = position;
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const distance = getDistanceFromLatLonInM(lat, lon, CAFE_LAT, CAFE_LON);
                    
                    if (distance <= MAX_DISTANCE_METERS) {
                        gpsStatus.textContent = "Dalam Jangkauan";
                        gpsStatus.className = 'font-bold text-green-700';
                    } else {
                        gpsStatus.textContent = "Di Luar Jangkauan";
                        gpsStatus.className = 'font-bold text-red-700';
                    }
                    distanceInfo.textContent = `Jarak: ${distance.toFixed(0)} meter (Akurasi: ${accuracy.toFixed(0)} meter).`;
                },
                (error) => {
                    let message = "Gagal mendapatkan lokasi. Pastikan izin lokasi aktif.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = "Anda menolak izin lokasi. Aktifkan di pengaturan browser.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "Informasi lokasi tidak tersedia saat ini.";
                            break;
                        case error.TIMEOUT:
                            message = "Waktu permintaan lokasi habis. Coba lagi.";
                            break;
                    }
                    gpsStatus.textContent = "Gagal";
                    gpsStatus.className = 'font-bold text-red-700';
                    distanceInfo.textContent = message;
                    refreshGpsBtn.classList.remove('hidden');
                },
                { enableHighAccuracy: true, timeout: 25000, maximumAge: 0 }
            );
        }
        
        function showMap() {
            if (!lastKnownPosition) {
                checkInitialGPS();
                alert("Mencoba mencari lokasi Anda. Silakan coba buka peta lagi sesaat.");
                return;
            }
            const userLat = lastKnownPosition.coords.latitude;
            const userLon = lastKnownPosition.coords.longitude;
            
            const iframe = document.createElement('iframe');
            iframe.width = "100%";
            iframe.height = "100%";
            iframe.style.border = "0";
            iframe.allowFullscreen = true;
            iframe.loading = "lazy";
            iframe.referrerPolicy="no-referrer-when-downgrade";
            iframe.src = `https://maps.google.com/maps?q=${CAFE_LAT},${CAFE_LON}&ll=${userLat},${userLon}&z=17&output=embed`;

            mapContainer.innerHTML = ''; // Clear previous map
            mapContainer.appendChild(iframe);
            
            mapModal.classList.remove('hidden');
        }

        async function startCamera(tipe) {
            if (!selectedUser) {
                absensiMessage.textContent = 'Pilih nama Anda terlebih dahulu.';
                absensiMessage.className = 'mt-4 text-center text-sm text-red-600';
                return;
            }
            absenTipe = tipe;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                videoFeed.srcObject = stream;
                cameraModal.classList.remove('hidden');
            } catch (err) {
                absensiMessage.textContent = 'Error: Tidak bisa mengakses kamera. Pastikan Anda memberikan izin.';
                absensiMessage.className = 'mt-4 text-center text-sm text-red-600';
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
        }

        async function capturePhoto() {
            showLoading('Mengambil foto & lokasi...');
            canvas.width = videoFeed.videoWidth;
            canvas.height = videoFeed.videoHeight;
            canvas.getContext('2d').drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');
            stopCamera();

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
                });
                const { latitude, longitude } = position.coords;
                const result = await submitAbsen(absenTipe, imageData, latitude, longitude);
                
                absensiMessage.textContent = result.message;
                absensiMessage.className = `mt-4 text-center text-sm ${result.success ? 'text-green-600' : 'text-red-600'}`;
            } catch (error) {
                 let message = 'Gagal mendapatkan lokasi GPS. Pastikan izin lokasi aktif dan coba lagi.';
                 if(error.code === error.TIMEOUT) {
                     message = 'Waktu permintaan lokasi habis. Pastikan sinyal GPS kuat.';
                 }
                 absensiMessage.textContent = message;
                 absensiMessage.className = 'mt-4 text-center text-sm text-red-600';
            } finally {
                hideLoading();
            }
        }
        
        async function handleSakitIjin(tipe) {
            if (!selectedUser) {
                absensiMessage.textContent = 'Pilih nama Anda terlebih dahulu.';
                absensiMessage.className = 'mt-4 text-center text-sm text-red-600';
                return;
            }
            showLoading('Mengirim data...');
            const result = await submitAbsen(tipe);
            absensiMessage.textContent = result.message;
            absensiMessage.className = `mt-4 text-center text-sm ${result.success ? 'text-green-600' : 'text-red-600'}`;
            hideLoading();
        }

        async function submitAbsen(tipe, imageData = null, lat = null, lon = null) {
             return await fetchAPI('submitAbsen', {
                 username: selectedUser,
                 tipe,
                 imageData,
                 lat,
                 lon
             });
        }

        function showManagerDashboard() {
            mainPage.classList.add('hidden');
            managerPage.classList.remove('hidden');
            const today = new Date();
            reportDateInput.valueAsDate = today;
            chartMonthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        }

        function showMainPage() {
            managerPage.classList.add('hidden');
            mainPage.classList.remove('hidden');
        }

        async function fetchManagerData() {
            const selectedDate = reportDateInput.value;
            if (!selectedDate) {
                alert('Silakan pilih tanggal terlebih dahulu.');
                return;
            }
            showLoading('Memuat laporan harian...');
            const result = await fetchAPI('getManagerReport', { date: selectedDate });

            if(result.success) {
                googleSheetLink.href = result.sheetUrl;
                renderReport(result.data);
            } else {
                 reportResults.innerHTML = `<p class="text-red-600">Gagal memuat laporan: ${result.message}</p>`;
            }
            hideLoading();
        }

        function renderReport(data) {
            reportResults.innerHTML = ''; 
            
            if (!data || (data.telat.length === 0 && data.cepatPulang.length === 0 && data.luarLokasi.length === 0)) {
                 reportResults.innerHTML = `<p class="text-gray-500">Tidak ada data pelanggaran untuk tanggal ini.</p>`;
                 return;
            }

            if (data.telat.length > 0) {
                let html = `<div class="p-4 bg-red-50 rounded-lg"><h4 class="font-bold text-red-800 mb-2">Karyawan Telat</h4><ul class="divide-y divide-red-200">`;
                data.telat.forEach(item => {
                    html += `<li class="py-2"><p class="font-semibold">${item.username}</p><p class="text-sm text-red-700">Masuk: ${item.jamMasuk} (${item.keterangan})</p></li>`;
                });
                html += `</ul></div>`;
                reportResults.innerHTML += html;
            }
            
            if (data.cepatPulang.length > 0) {
                let html = `<div class="p-4 bg-orange-50 rounded-lg"><h4 class="font-bold text-orange-800 mb-2">Karyawan Pulang Cepat</h4><ul class="divide-y divide-orange-200">`;
                data.cepatPulang.forEach(item => {
                    html += `<li class="py-2"><p class="font-semibold">${item.username}</p><p class="text-sm text-orange-700">Pulang: ${item.jamPulang} (${item.keterangan})</p></li>`;
                });
                html += `</ul></div>`;
                reportResults.innerHTML += html;
            }
            
            if (data.luarLokasi.length > 0) {
                let html = `<div class="p-4 bg-indigo-50 rounded-lg"><h4 class="font-bold text-indigo-800 mb-2">Absen di Luar Lokasi</h4><ul class="divide-y divide-indigo-200">`;
                data.luarLokasi.forEach(item => {
                    html += `<li class="py-2"><p class="font-semibold">${item.username}</p><p class="text-sm text-indigo-700">Absen ${item.tipe} pukul ${item.jam}</p></li>`;
                });
                html += `</ul></div>`;
                reportResults.innerHTML += html;
            }
        }
        
        async function fetchMonthlyChartData() {
            const month = chartMonthInput.value;
            if (!month) {
                alert('Pilih bulan dan tahun terlebih dahulu.');
                return;
            }
            showLoading('Memuat data grafik...');
            const result = await fetchAPI('getMonthlyChartData', { month });

            if(result.success) {
                renderMonthlyChart(result.data);
            } else {
                alert('Gagal memuat data grafik: ' + result.message);
            }
            hideLoading();
        }

        function renderMonthlyChart(data) {
            const labels = Object.keys(data);
            const telatData = labels.map(label => data[label].telat);
            const cepatPulangData = labels.map(label => data[label].cepatPulang);

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(monthlyChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Telat',
                            data: telatData,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)', // red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Pulang Cepat',
                            data: cepatPulangData,
                            backgroundColor: 'rgba(249, 115, 22, 0.6)', // orange
                            borderColor: 'rgba(249, 115, 22, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Laporan Pelanggaran Bulan ${chartMonthInput.value}`
                        }
                    }
                }
            });
        }
        
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- EVENT LISTENERS ---
        employeeSelect.addEventListener('change', onEmployeeSelect);
        saveRosterBtn.addEventListener('click', saveRoster);
        
        absenMasukBtn.addEventListener('click', () => startCamera('masuk'));
        absenPulangBtn.addEventListener('click', () => startCamera('pulang'));
        absenSakitBtn.addEventListener('click', () => handleSakitIjin('sakit'));
        absenIjinBtn.addEventListener('click', () => handleSakitIjin('ijin'));
        
        captureBtn.addEventListener('click', capturePhoto);
        cancelCaptureBtn.addEventListener('click', stopCamera);
        
        checkLocationBtn.addEventListener('click', showMap);
        closeMapBtn.addEventListener('click', () => mapModal.classList.add('hidden'));

        managerAccessBtn.addEventListener('click', showManagerDashboard);
        backToMainBtn.addEventListener('click', showMainPage);
        showReportBtn.addEventListener('click', fetchManagerData);
        showChartBtn.addEventListener('click', fetchMonthlyChartData);
        refreshGpsBtn.addEventListener('click', checkInitialGPS);
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchEmployees();
            checkInitialGPS();
        });
    </script>

</body>
</html>

