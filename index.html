<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi Payboss Cafe — FINAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    body{font-family:'Inter',sans-serif}
    #map{height:260px}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold text-center">Absensi Payboss Cafe</h1>
    <p class="text-center text-[11px] text-gray-500 mb-4">Akses via <b>HTTPS</b> dan izinkan <b>Precise Location</b>.</p>

    <!-- Server status -->
    <div class="p-3 rounded border bg-white mb-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-600">Server</p>
          <p id="server-status" class="text-sm font-semibold">Menyambungkan...</p>
        </div>
        <button id="retry-server" class="text-xs px-2 py-1 rounded bg-indigo-600 text-white">Coba Lagi</button>
      </div>
      <p id="server-detail" class="text-[11px] text-gray-500 mt-1"></p>
    </div>

    <!-- Employee -->
    <div class="mb-4">
      <label class="text-sm font-medium">Pilih Nama Karyawan</label>
      <select id="employee" class="w-full border rounded p-2 mt-1">
        <option value="">Memuat...</option>
      </select>
    </div>

    <!-- Roster -->
    <div class="p-3 rounded bg-gray-50 mb-4">
      <p class="text-sm font-semibold text-gray-700 mb-2">Jadwal Shift Hari Ini</p>
      <div class="flex gap-2">
        <select id="shift" class="flex-1 border rounded p-2 text-sm">
          <option value="">-- Pilih Shift --</option>
          <option value="08:00">Pagi (08:00 - 16:00)</option>
          <option value="16:00">Sore (16:00 - 24:00)</option>
          <option value="00:00">Malam (00:00 - 08:00)</option>
        </select>
        <button id="save-shift" class="px-3 py-2 rounded bg-slate-700 text-white text-sm">Simpan</button>
      </div>
      <p id="shift-info" class="text-xs text-gray-600 mt-2"></p>
    </div>

    <!-- GPS -->
    <div class="p-3 rounded bg-blue-50 mb-4">
      <div class="flex items-center justify-between">
        <p id="gps-status" class="text-sm font-semibold text-blue-700">Menunggu izin lokasi...</p>
        <span id="gps-acc" class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 hidden"></span>
      </div>
      <p id="gps-info" class="text-xs text-gray-600"></p>
      <div class="flex gap-2 mt-2">
        <button id="btn-map" class="flex-1 bg-white border text-blue-700 rounded p-2 text-sm">Lihat Peta</button>
        <button id="btn-gps" class="flex-1 bg-white border text-amber-700 rounded p-2 text-sm">Kalibrasi Ulang</button>
      </div>
    </div>

    <!-- Actions -->
    <div class="grid grid-cols-2 gap-3">
      <button id="btn-masuk" class="bg-green-600 text-white p-3 rounded">Absen Masuk</button>
      <button id="btn-pulang" class="bg-red-600 text-white p-3 rounded">Absen Pulang</button>
      <button id="btn-sakit" class="bg-yellow-500 text-white p-3 rounded">Sakit</button>
      <button id="btn-ijin" class="bg-blue-500 text-white p-3 rounded">Ijin</button>
    </div>

    <p id="msg" class="text-center text-sm mt-4"></p>

    <!-- Diagnostics -->
    <details class="mt-4">
      <summary class="text-xs text-gray-600 cursor-pointer">Lihat log diagnosa</summary>
      <pre id="log" class="log text-[11px] p-2 bg-white border rounded mt-2"></pre>
    </details>
  </div>

  <!-- Map modal -->
  <div id="map-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-3">
    <div class="bg-white rounded p-3 w-11/12 max-w-lg">
      <div id="map" class="rounded"></div>
      <button id="close-map" class="mt-3 w-full bg-gray-700 text-white p-2 rounded">Tutup</button>
    </div>
  </div>

  <script>
    // ===== KONFIGURASI =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLMHiNICkfdt2q8S8AMAIY_Ji0JA_5XxpCpnV1oq51b-A_O1HwMzwbzAAhbCO9FjrQCw/exec";
    // 📍 Samakan dengan Google Script (lihat proyek Apps Script FINAL)
    const CAFE_LAT = -2.160345;
    const CAFE_LON = 115.432198;
    const RADIUS_M = 50;

    // ===== Elements =====
    const elServer = document.getElementById('server-status');
    const elServerDetail = document.getElementById('server-detail');
    const elRetryServer = document.getElementById('retry-server');

    const elEmployee = document.getElementById('employee');
    const elShift = document.getElementById('shift');
    const elSaveShift = document.getElementById('save-shift');
    const elShiftInfo = document.getElementById('shift-info');

    const elMsg = document.getElementById('msg');

    const elGpsStatus = document.getElementById('gps-status');
    const elGpsInfo = document.getElementById('gps-info');
    const elGpsAcc = document.getElementById('gps-acc');

    const logEl = document.getElementById('log');

    // ===== Helpers =====
    const log = (...a) => { console.log(...a); logEl.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ') + "\n"; };
    const fmt = n => Number.isFinite(n) ? Math.round(n) : '-';
    const dist = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3; const toRad = d => d*Math.PI/180;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    };

    // ===== Server check + load employees & roster =====
    async function checkServerAndLoad(){
      elServer.textContent = 'Menyambungkan...'; elServer.className = 'text-sm font-semibold text-gray-800';
      try{
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 10000);
        const res = await fetch(`${SCRIPT_URL}?action=getEmployees`, { signal: controller.signal, cache: 'no-store' });
        clearTimeout(t);
        log('GET /getEmployees status:', res.status);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        if(json.success){
          elServer.textContent = 'Terhubung'; elServer.className = 'text-sm font-semibold text-green-700'; elServerDetail.textContent = '';
          elEmployee.innerHTML = '<option value="">-- Pilih Karyawan --</option>';
          json.data.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; elEmployee.appendChild(o); });
        } else throw new Error(json.message||'Respon tidak valid');
      }catch(err){
        elServer.textContent = 'Gagal tersambung'; elServer.className = 'text-sm font-semibold text-red-700';
        elServerDetail.textContent = 'Detail: '+err.message+' — Pastikan Web App sudah Deploy (Anyone with the link) & URL benar.';
        elEmployee.innerHTML = '<option value="">Gagal koneksi ke server</option>';
        log('Server error:', err);
      }
    }

    elRetryServer.addEventListener('click', checkServerAndLoad);

    // Load roster saat pilih karyawan
    elEmployee.addEventListener('change', async (e)=>{
      elShiftInfo.textContent = '';
      elShift.value = '';
      const user = e.target.value; if(!user) return;
      try{
        const r = await fetch(`${SCRIPT_URL}?action=getRoster&username=${encodeURIComponent(user)}`);
        const j = await r.json();
        if(j.success && j.jadwal){ elShift.value = j.jadwal; elShiftInfo.textContent = `Shift hari ini: ${j.jadwal}`; elShiftInfo.className = 'text-xs text-green-700 mt-2'; }
        else { elShiftInfo.textContent = 'Belum pilih shift hari ini.'; elShiftInfo.className = 'text-xs text-amber-700 mt-2'; }
      }catch(err){ elShiftInfo.textContent = 'Gagal memuat shift.'; elShiftInfo.className = 'text-xs text-red-700 mt-2'; }
    });

    elSaveShift.addEventListener('click', async ()=>{
      const user = elEmployee.value; const s = elShift.value;
      if(!user || !s){ elShiftInfo.textContent = 'Pilih nama & shift dulu.'; elShiftInfo.className = 'text-xs text-red-700 mt-2'; return; }
      try{
        const fd = new URLSearchParams(); fd.append('action','setRoster'); fd.append('username',user); fd.append('shift',s);
        const r = await fetch(SCRIPT_URL, { method:'POST', body: fd });
        const j = await r.json();
        if(j.success){ elShiftInfo.textContent = `Shift disimpan: ${s}`; elShiftInfo.className = 'text-xs text-green-700 mt-2'; }
        else { elShiftInfo.textContent = j.message || 'Gagal menyimpan shift.'; elShiftInfo.className = 'text-xs text-red-700 mt-2'; }
      }catch(err){ elShiftInfo.textContent = 'Error jaringan saat menyimpan.'; elShiftInfo.className = 'text-xs text-red-700 mt-2'; }
    });

    // ===== GPS =====
    let lastPos = null; let mapObj = null;

    async function getBestPosition(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation) return reject(new Error('Geolocation tidak didukung'));
        let best=null; let count=0; const MAX_SAMPLES=6; const MAX_WAIT=12000;
        const id = navigator.geolocation.watchPosition(p=>{
          count++; if(!best || p.coords.accuracy < best.coords.accuracy) best=p;
          if(best.coords.accuracy <= 25 || count>=MAX_SAMPLES){ navigator.geolocation.clearWatch(id); resolve(best); }
        }, err=>{
          navigator.geolocation.clearWatch(id);
          navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy:true, timeout:MAX_WAIT, maximumAge:0});
        }, {enableHighAccuracy:true, timeout:MAX_WAIT, maximumAge:0});
        setTimeout(()=>{ try{navigator.geolocation.clearWatch(id);}catch{}; best?resolve(best):reject(new Error('Timeout lokasi')); }, MAX_WAIT);
      });
    }

    async function updateGPS(){
      elGpsStatus.textContent = 'Mencari lokasi...'; elGpsStatus.className = 'text-sm font-semibold text-blue-700';
      elGpsAcc.classList.add('hidden'); elGpsInfo.textContent = 'Jika diminta izin, pilih Allow & aktifkan Precise.';
      try{
        const pos = await getBestPosition();
        lastPos = pos;
        const {latitude, longitude, accuracy} = pos.coords;
        const d = dist(latitude, longitude, CAFE_LAT, CAFE_LON);
        elGpsAcc.textContent = `±${fmt(accuracy)} m`; elGpsAcc.classList.remove('hidden');
        elGpsInfo.textContent = `Jarak ke kafe: ${fmt(d)} m (akurasi ±${fmt(accuracy)} m)`;
        if(d <= RADIUS_M){ elGpsStatus.textContent='Dalam Jangkauan'; elGpsStatus.className='text-sm font-semibold text-green-700'; }
        else { elGpsStatus.textContent='Di Luar Jangkauan'; elGpsStatus.className='text-sm font-semibold text-red-700'; }
      }catch(err){
        elGpsStatus.textContent = 'Gagal mendapatkan lokasi'; elGpsStatus.className = 'text-sm font-semibold text-red-700';
        elGpsInfo.textContent = 'Aktifkan lokasi presisi di pengaturan browser/OS, lalu coba lagi.';
        log('GPS error:', err);
      }
    }

    document.getElementById('btn-gps').addEventListener('click', updateGPS);

    // Map
    const modal = document.getElementById('map-modal');
    document.getElementById('btn-map').addEventListener('click', ()=>{
      if(!lastPos) return alert('Lokasi belum tersedia. Klik Kalibrasi Ulang dulu.');
      modal.classList.remove('hidden');
      setTimeout(()=>{
        const {latitude, longitude}=lastPos.coords;
        const mapDiv = document.getElementById('map'); mapDiv.innerHTML = '';
        mapObj = L.map('map').setView([latitude, longitude], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(mapObj);
        L.marker([CAFE_LAT, CAFE_LON]).addTo(mapObj).bindPopup('Payboss Cafe');
        L.marker([latitude, longitude]).addTo(mapObj).bindPopup('Lokasi Anda');
        const bounds = L.latLngBounds([ [CAFE_LAT, CAFE_LON], [latitude, longitude] ]);
        mapObj.fitBounds(bounds.pad(0.3));
      }, 50);
    });
    document.getElementById('close-map').addEventListener('click', ()=> modal.classList.add('hidden'));

    // ===== Submit =====
    async function submitAbsen(type){
      const user = elEmployee.value; if(!user) return alert('Pilih nama dulu.');
      elMsg.textContent = 'Mengirim...'; elMsg.className = 'text-center text-gray-700 text-sm';
      try{
        const fd = new URLSearchParams();
        fd.append('action','submitAbsen'); fd.append('username', user); fd.append('tipe', type);
        if(lastPos){ fd.append('lat', lastPos.coords.latitude); fd.append('lon', lastPos.coords.longitude); }
        const controller = new AbortController(); const t=setTimeout(()=>controller.abort(), 12000);
        const res = await fetch(SCRIPT_URL, { method:'POST', body: fd, signal: controller.signal }); clearTimeout(t);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        elMsg.textContent = json.message || (json.success?'Berhasil':'Gagal');
        elMsg.className = 'text-center text-sm ' + (json.success ? 'text-green-600':'text-red-600');
        log('submitAbsen response:', json);
      }catch(err){
        elMsg.textContent = 'Gagal kirim: '+err.message+" — cek CORS/Deploy & koneksi.";
        elMsg.className = 'text-center text-sm text-red-600';
        log('submitAbsen error:', err);
      }
    }

    document.getElementById('btn-masuk').addEventListener('click', ()=>submitAbsen('masuk'));
    document.getElementById('btn-pulang').addEventListener('click', ()=>submitAbsen('pulang'));
    document.getElementById('btn-sakit').addEventListener('click', ()=>submitAbsen('sakit'));
    document.getElementById('btn-ijin').addEventListener('click', ()=>submitAbsen('ijin'));

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      if(location.protocol!=='https:' && location.hostname!=='localhost'){
        document.getElementById('server-detail').textContent = 'Peringatan: Situs tidak melalui HTTPS. Beberapa device menolak GPS presisi.';
      }
      checkServerAndLoad();
      updateGPS();
    });
  </script>
</body>
</html>