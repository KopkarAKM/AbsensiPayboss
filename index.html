<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Payboss Cafe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #map { height: 250px; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-2">Absensi Payboss Cafe</h1>
    <p class="text-center text-xs text-gray-500 mb-4">Pastikan situs diakses melalui HTTPS agar GPS presisi.</p>

    <div class="mb-3">
      <label class="text-sm font-medium">Pilih Nama Karyawan</label>
      <select id="employee-select" class="w-full border rounded p-2">
        <option>Memuat...</option>
      </select>
    </div>

    <div class="p-3 bg-blue-50 rounded mb-4">
      <p id="gps-status" class="text-sm font-semibold text-blue-700">Mencari lokasi...</p>
      <p id="distance-info" class="text-xs text-gray-600"></p>
      <div class="flex gap-2 mt-2">
        <button id="check-location-btn" class="flex-1 bg-white border text-blue-700 rounded p-2 text-sm">Lihat Peta</button>
        <button id="calibrate-btn" class="flex-1 bg-white border text-amber-700 rounded p-2 text-sm">Kalibrasi Ulang</button>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <button id="absen-masuk" class="bg-green-600 text-white p-3 rounded">Absen Masuk</button>
      <button id="absen-pulang" class="bg-red-600 text-white p-3 rounded">Absen Pulang</button>
      <button id="absen-sakit" class="bg-yellow-500 text-white p-3 rounded">Sakit</button>
      <button id="absen-ijin" class="bg-blue-500 text-white p-3 rounded">Ijin</button>
    </div>

    <p id="absensi-message" class="text-center text-sm mt-4"></p>
  </div>

  <div id="map-modal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center">
    <div class="bg-white rounded-lg p-3 w-11/12 max-w-lg">
      <div id="map" class="rounded mb-3"></div>
      <button id="close-map" class="bg-gray-700 text-white w-full p-2 rounded">Tutup</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzps8knJrgpD_kl25oo_R7abFV1QC8S4OJ_NF4hFw9_cLIlHkcvAAPiaYT4PigF7p9XGA/exec";
    const CAFE_LAT = -8.679199;
    const CAFE_LON = 115.223842;
    const MAX_DISTANCE = 50;
    let currentPos = null;

    const select = document.getElementById('employee-select');
    const statusEl = document.getElementById('gps-status');
    const distanceInfo = document.getElementById('distance-info');
    const msgEl = document.getElementById('absensi-message');

    async function loadEmployees(){
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getEmployees`);
        const json = await res.json();
        if(json.success){
          select.innerHTML = '<option value="">-- Pilih Karyawan --</option>';
          json.data.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n; opt.textContent = n;
            select.appendChild(opt);
          });
        } else select.innerHTML = '<option>Error memuat data</option>';
      } catch(e){
        select.innerHTML = '<option>Gagal koneksi ke server</option>';
      }
    }

    async function getLocation(){
      statusEl.textContent = 'Mencari lokasi...';
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude, accuracy} = pos.coords;
        currentPos = {latitude, longitude, accuracy};
        const dist = distance(latitude, longitude, CAFE_LAT, CAFE_LON);
        distanceInfo.textContent = `Jarak ke kafe: ${Math.round(dist)} m (akurasi ±${Math.round(accuracy)} m)`;
        if(dist <= MAX_DISTANCE){
          statusEl.textContent = 'Dalam Jangkauan';
          statusEl.className = 'text-sm font-semibold text-green-700';
        } else {
          statusEl.textContent = 'Di Luar Jangkauan';
          statusEl.className = 'text-sm font-semibold text-red-700';
        }
      }, err=>{
        statusEl.textContent = 'Gagal dapat lokasi';
      }, {enableHighAccuracy:true, timeout:10000});
    }

    function distance(lat1,lon1,lat2,lon2){
      const R = 6371e3;
      const φ1 = lat1*Math.PI/180, φ2 = lat2*Math.PI/180;
      const Δφ = (lat2-lat1)*Math.PI/180;
      const Δλ = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function submitAbsen(tipe){
      const user = select.value;
      if(!user) return alert('Pilih nama terlebih dahulu!');
      msgEl.textContent = 'Mengirim data...';
      try{
        const form = new FormData();
        form.append('action','submitAbsen');
        form.append('username',user);
        form.append('tipe',tipe);
        if(currentPos){
          form.append('lat',currentPos.latitude);
          form.append('lon',currentPos.longitude);
        }
        const res = await fetch(SCRIPT_URL,{method:'POST',body:form});
        const json = await res.json();
        msgEl.textContent = json.message;
        msgEl.className = json.success ? 'text-center text-green-600 text-sm' : 'text-center text-red-600 text-sm';
      }catch(err){
        msgEl.textContent = 'Gagal kirim data';
        msgEl.className = 'text-center text-red-600 text-sm';
      }
    }

    document.getElementById('absen-masuk').onclick=()=>submitAbsen('masuk');
    document.getElementById('absen-pulang').onclick=()=>submitAbsen('pulang');
    document.getElementById('absen-sakit').onclick=()=>submitAbsen('sakit');
    document.getElementById('absen-ijin').onclick=()=>submitAbsen('ijin');
    document.getElementById('calibrate-btn').onclick=getLocation;

    // Map
    const mapModal=document.getElementById('map-modal');
    const closeMap=document.getElementById('close-map');
    document.getElementById('check-location-btn').onclick=()=>{
      if(!currentPos) return alert('Lokasi belum ditemukan!');
      mapModal.classList.remove('hidden');
      const map=L.map('map').setView([CAFE_LAT,CAFE_LON],15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
      L.marker([CAFE_LAT,CAFE_LON]).addTo(map).bindPopup('Payboss Cafe');
      L.marker([currentPos.latitude,currentPos.longitude]).addTo(map).bindPopup('Lokasi Anda');
    };
    closeMap.onclick=()=>mapModal.classList.add('hidden');

    loadEmployees();
    getLocation();
  </script>
</body>
</html>